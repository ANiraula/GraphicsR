---
title: "Dallas Police and Fire Pension System Pension Solvency Analysis"
author: "Prepared by: Pension Integrity Project at Reason Foundation February 18, 2020"
date: "02/218/2021"
output:
  powerpoint_presentation:
    reference_doc: template_deck.pptx
  beamer_presentation: default
font-family: Arial
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  #dev = "svg",
  fig.width = 12,
  fig.height = 7
  #Font size (Graphs + Text)
  #Source line
  #Header
)
#Update linePlot() for Treasury functionality
#Update linePlot() for shaded UAL area/line plot
#Create glPlot() w/ function to turn "interactive" parameter TRUE/FALSE to create Plotly graph (eventually use database data)
#Create barPlot() w/ manual ready data + database calculated Neg.Amo + interest on Debt
#
```
 
### About the Pension Integrity Project

We offer pro-bono technical assistance to public officials to help them design and implement pension reforms that improve plan solvency and promote retirement security, including: </p>
- Customized analysis of pension system design, trends </p>
- Independent actuarial modeling of reform scenarios </p>
- Consultation and modeling around custom policy designs </p>
- Latest pension reform research and case studies </p>
- Peer-to-peer mentoring from state and local officials who have successfully enacted pension reforms </p> 
- Assistance with stakeholder outreach, engagement and relationship management </p>
- Design and execution of public education programs and media campaigns </p>

### A History of Weakening Solvency (2001-2019) w/ R (areaPlot())

```{r debt, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(xlsx)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#write.xlsx(DPF.data, "DPF.data.xlsx")


DPF.data$year <- as.numeric(DPF.data$year)
DPF.data$ava <- as.numeric(DPF.data$ava)
DPF.data$aal <- as.numeric(DPF.data$aal)

## Moving AAL + Payroll 1 year back
DPF.data$aal[1:19] <- DPF.data$aal[2:20]
DPF.data$aal[20] <- NA
DPF.data$payroll[1:19] <- DPF.data$payroll[2:20]
DPF.data$payroll[20] <- NA

areaPlot <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
  ticks = TRUE, sp500 = FALSE, font) 
{
  if (isTRUE(sp500)) {
    urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
    SP500 <- read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    SP500 <- SP500 %>% filter(year >= min(data$year))
    data <- cbind(data, SP500[, 2])
    graph <- data.frame(data %>% select(year, SP500 = sp_500, 
      funded_ratio) %>% tidyr::drop_na())
  }
  else {
    data <- as.data.table(data)
    data$uaal <- (data$aal - data$ava)
    
    data <- data %>% dplyr::filter(data$uaal != 0)
    extrapo <- stats::approx(data$year, data$uaal, n = 10000)
    extrapo2 <- stats::approx(data$year, data$funded_ratio, 
      n = 10000)
    graph <- data.frame(year = extrapo$x, uaal = extrapo$y, 
      funded_ratio = extrapo2$y) %>% tidyr::drop_na()
    graph <- graph %>% dplyr::mutate(sign = dplyr::case_when(.data$uaal >= 
      0 ~ "positive", .data$uaal < 0 ~ "negative"))
  }
  graph$funded_ratio <- as.numeric(graph$funded_ratio)
  graph$year <- as.numeric(graph$year)
  if (!isTRUE(sp500)) {
    graph$uaal <- as.numeric(graph$uaal)
  }
  y_minimum <- as.numeric(min(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    0
  }))
  y_maximum <- as.numeric(max(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    graph$SP500
  }))
  reasontheme::set_reason_theme(style = "slide")

  ggplot2::ggplot(graph, ggplot2::aes(x = graph$year)) + ggplot2::geom_area(ggplot2::aes(y = if (!isTRUE(sp500)) {
    graph$uaal
  }
  else {
    graph$SP500
  }, fill = if (!isTRUE(sp500)) {
    graph$sign
  }
  else {
    palette_reason$Orange
  })) + ggplot2::geom_line(ggplot2::aes(y = graph$funded_ratio * 
    (y_maximum)), color = palette_reason$GreyBlue, size = 1.5) + 
    ggplot2::labs(y = if (!isTRUE(sp500)) {
      "Unfunded Accrued Actuarial Liabilities (Millions)"
    }
    else {
      "S&P500 Index"
    }, x = NULL) + ggplot2::scale_fill_manual(values = if (!isTRUE(sp500)) {
    c(negative = paste(palette_reason$Green), positive = paste(palette_reason$Red))
  }
  else {
    c(paste(palette_reason$Yellow))
  }) + ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = scales::dollar_format(prefix = if (!isTRUE(sp500)) {
      "$"
    }
    else {
      ""
    }, scale = if (!isTRUE(sp500)) {
      (1e-06)
    }
    else {
      1
    }, largest_with_cents = if (!isTRUE(sp500)) {
      1
    }
    else {
      0.001
    }),  sec.axis = ggplot2::sec_axis(~./(y_maximum/100), 
      breaks = scales::pretty_breaks(n = 10), name = "Funded Ratio", 
      labels = function(b) {
        paste0(round(b, 0), "%")
      }), expand = c(0, 0)) + geom_hline(yintercept = 0, 
    linetype = "solid", color = "black", size = 0.5) + labs(title = paste(title), 
    caption = ifelse(isTRUE(caption), paste("reason.org/pensions"), 
      paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) +ggplot2::theme(axis.title.y = element_text(face="bold"))+
    ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    
    coord_cartesian(expand = FALSE, xlim = c(min(graph$year), 
      max(graph$year)), ylim = c(min(0,y_minimum), y_maximum * 
      1.2)) + ggplot2::scale_x_continuous(breaks = round(seq(min(graph$year), 
    max(graph$year), by = 2), 1), expand = c(0, 0)) + ggplot2::theme(legend.position = "none") + 
    ggplot2::theme(text = element_text(family = paste(font), 
      size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}


debt <- areaPlot(DPF.data, caption = F, grid = F, ticks = F, sp500 = F, font = "Calibri")

debt

```

::: notes
Mountain of Debt Plot for Dallas PFPS
::: 


### Causes of Pension Debt (2001-2019) w/ R (custom Plotly-Image)
```{r ,dpi=400}
     ########## Arkansas PERS Dashboard ##########
##Data: Manually Collected
##By: Anil, Jordan, Swaroop

### Clean Global Environment ###
rm(list = ls())

#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
### Load Packages ###
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
#install.packages("data.table")
library(pensionviewr)
library(tseries)
library(data.table)
library(openxlsx)
library(readr)
library(rsconnect)
library(ggplot2)
library(tidyverse)
library(shiny)
library(shinyWidgets)
library(shinydashboard)
library(htmlwidgets)
library(DT)
library(plotly)
library(plyr)
library(dplyr)
library(orca)
library(png)


### Dallas Police and Fire Pension System ###

glPlot <- function(
      url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/APERS_GL.csv", 
      interactive = FALSE, fileName = "GainLoss.png",
      title = "<b>Causes of Arkansas ERS Pension Debt (2001-2020)<b>",
      caption = FALSE,
      yaxisScale = 1e-06,
      yaxisMax = 4.5, 
      lab1 = "Investment<br>Returns", 
      lab2 = "Benefit<br>Changes<br> & Other",
      lab3 = "Changes to<br>Actuarial<br>Methods &<br>Assumptions", 
      lab4 = "Negative<br>Amortization",
      lab5 = "Deviations from<br>Demographic<br>Assumptions",
      lab6 = "Gains From<br>Pay<br>Increases<br>Not Given",
      lab7 = "<b>Net Change to<br>Unfunded<br>Liability<b>"){
  
  #[1] Load Gain/Loss data from the provided url
  urlfile= "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/DPFPF_GL.csv"
  data <- read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types =       NULL)
  data <- as.data.table(data)# convert to data.table
  
  #[2] Calculate Total Gain/Loss for each column (i.e. Net Change to UAL over the years)
    y = data[,lapply(.SD,sum),.SDcols=colnames(data)]*yaxisScale
    y = y[,!1]# sum values by each column
    y = t(y)#Saving needed columns and transposing table for graphics
 
  #[3] Combine gain/loss data & categories to create interactive Waterfall chart w/ plotly
    x = list(lab1, lab2, lab3, lab4, lab5, lab6)

    data <- data.frame(x = factor(x, levels = x), y)

    data <- data %>% dplyr::mutate(measure = dplyr::case_when(.data$y > 
    0 ~ "relative", .data$y < 0 ~ "negative"))
    
    data[length(data[,3]),]$measure <- "total"

    #  m <- list(
    #  l = 50,
    #  r = 0,
    #  b = 0,
    #  t = 50,
    #  pad = 4
    #  )

    #[4] Visualizing with Plotly
    fig <- plot_ly( data,
                    type = "waterfall",
                    measure = ~measure,
                    x = ~x,
                    textposition = "outside",
                    y= ~y,
                    decreasing = list(marker = list(color = palette_reason$Green)),
                    increasing = list(marker = list(color = palette_reason$Red)),
                    totals = list(marker = list(color = palette_reason$Orange)),
                    connector = list(line = list(color= palette_reason$SpaceGrey, width = 1))) 

    fig <- fig %>%
      layout(title = paste0(title),
             xaxis = list(title = "",tickfont = list(size = 11, face = "bold")),
             yaxis = list(title = "<b>Change in Unfunded Liability (in $Billions)<b>",
                          titlefont = list(size = 12), range = c(0,yaxisMax),
                          showgrid = FALSE,
                          tick0 = 0,
                          dtick = 0.5,
                          ticklen = 2,
                          linecolor = '#636363',
                          linewidth = 0.75),
             barmode = 'stack',
             autosize = F,
             width = 900, height = 550,
             showlegend = F)
    
    
    #`Save` as a `static` png file 
    #OR `show` as a `interactive` Plotly chart
    if(!isTRUE(interactive)){
    #Save Plotly as a Static PNG on a local computer (to reference in rmarkdown later)
    #https://github.com/plotly/orca
    orca(fig, paste0(fileName))}else{fig}
}

#Code to save Static graph
glPlot(url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/DPFPF_GL.csv",   
      interactive = FALSE,
      fileName = "DPFP.GainLoss.png",
      title = "",#"<b>Causes of Arkansas ERS Pension Debt (2001-2019)<b>",
      caption = FALSE,
      yaxisScale = 1e-09,
      yaxisMax = 4.5, 
      lab1 = "<b>Investment<br>Returns<b>", 
      lab2 = "<b>Negative<br>Amortization",
      lab3 = "<b>Contribution <br>Deficiency<b>",
      lab4 = "<b>Deviations from<br>Demographic<br>Assumptions<br>And Other<b>",
      lab5 = "<b>Changes to<br>Actuarial<br>Methods &<br>Assumptions<b>",
      lab6 = "<b>Net Change to<br>Unfunded<br>Liability<b>")

#Code to show Interactive graph
#fig <- glPlot(url = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/APERS_GL.csv",       interactive = TRUE,
#      fileName = "GainLoss.png",
#      title = "<b>Causes of Arkansas ERS Pension Debt (2001-2019)<b>",
#      caption = TRUE,
#      lab1 = "Investment<br>Returns", 
#      lab2 = "Benefit<br>Changes<br> & Other",
#      lab3 = "Changes to<br>Actuarial<br>Methods &<br>Assumptions", 
#      lab4 = "Negative<br>Amortization",
#      lab5 = "Deviations from<br>Demographic<br>Assumptions",
#      lab6 = "Gains From<br>Pay<br>Increases<br>Not Given",
#      lab7 = "Net Change to<br>Unfunded<br>Liability")

#Uncomment "fig" below*
#fig

```
![](DPFP.GainLoss.png)

### Make up of Pension Contributions w/ R (custom)
```{r}
rm(list=ls())

library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(DT)
library(scales)

###
##Pull PERSI data
##Load list of plans

#PULL DATA
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#write.xlsx(DPF.data, "DPF.data.xlsx")


DPF.data$year <- as.numeric(DPF.data$year)
DPF.data$ava <- as.numeric(DPF.data$ava)
DPF.data$aal <- as.numeric(DPF.data$aal)
#View(DPF.data)
Data <- DPF.data %>% filter(year==2018)

#Create table skeleton
table <- matrix(NA,7,3)
table[3:7,1] <- c("Total Employee", 
               "Employer (Normal Cost)", 
               "Employer (Debt Amortization)", 
               "Total Employer", 
               paste0("Total ", unique(DPF.data$plan_name), " Contributions"))
#View(table)
#Use database numbers to populate/calculate needed values
table[2,2] <- c("% of payroll")
table[2,3] <- c("$ Value")
table[3,2] <- as.numeric(Data$ee_nc_pct)
table[3,3] <- as.numeric(Data$ee_contribution)
table[4,2] <- as.numeric(Data$total_nc_pct)-as.numeric(Data$ee_nc_pct)
table[4,3] <- as.numeric(table[4,2]) * as.numeric(Data$payroll)
table[5,2] <- as.numeric(Data$total_amortization_payment_pct)
table[5,3] <- as.numeric(Data$total_amortization_payment_pct) * as.numeric(Data$payroll)
table[6,2] <- sum(as.numeric(table[4:5,2]))
table[6,3] <- sum(as.numeric(table[4:5,3]))
table[7,2] <- as.numeric(Data$total_nc_pct)+as.numeric(Data$total_amortization_payment_pct)
table[7,3] <- as.numeric(Data$total_contribution)

table <- data.table(table)
colnames(table) <- c("Name", "Payroll", "Value")
table <- table[3:7,]
table$Value <- as.numeric(table$Value)
table$Payroll <- as.numeric(table$Payroll)

#Format data to %/$ for appearance
table[,3] <- scales::dollar(table$Value)
table[,2] <- scales::percent(table$Payroll, accuracy = 0.1)
colnames(table) <- c("", "% of Payroll", "$ Value")

#View(table)
#Knit the table
knitr::kable(
  table, caption = 'Pension Integrity Project pension database.'
)
```

### A History of Investment Returns (2001-2019) w/ R (linePlot())
```{r graph, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
### linePlot ###
## Data: Database + Manual(AVA returns)
## Base: linePlot() function in `pensionviewr`
# By: Anil, Swaroop, and Jen

##linePlot() function parameters:

#data = data in data.frame, tibble, or data.table format,
#yaxisMin & yaxisMax = Y-axis mininum and maximum values
#yaxisSeq = set sequency of Major breaks
#yaxisScale = 100 for percentages
#format = set Y-axis format to either "%", "$", or empty
#str = set number of srings at which to cut legend text (default is 20),
#labelY = title of Y-axis,
#lab1 - lab5 = character string of line titles/names (default is 0 Lines)

###################
#Using 2 New Functions to download and filter datat from datatabase
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#View(DPF.data)

DPF.data$year <- as.numeric(DPF.data$year)
DPF.data$ava <- as.numeric(DPF.data$ava)
DPF.data$aal <- as.numeric(DPF.data$aal)
DPF.data$ava_return <- as.numeric(DPF.data$ava_return)
DPF.data$arr <- as.numeric(DPF.data$arr)
DPF.data$return_1yr <- as.numeric(DPF.data$return_1yr)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

DPF.data <- DPF.data %>% select(year, return_1yr, ava_return, arr, dr)
DPF.data <- data.table(DPF.data)
DPF.data[year == 2005]$ava_return <-   DPF.data[year == 2005]$return_1yr

DPF.data$year <- seq(2000, 2019, by = 1)
DPF.data <- DPF.data %>% filter(year>2000)

#####Modified linePlot

#Inv. Returns      
graph <- linePlot(DPF.data, title = "", inv.returns = TRUE, treasury = FALSE,
                  font = "Calibri", yaxisMin = -27, yaxisMax = 33, yaxisSeq = 3,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "", lab1 = "Market Valued Returns (Actual)", 
                  lab2 = "Actuarially Valued Investment Return (Smoothed by Plan)", 
                  lab3 = "Assumed Rate of Return", lab4 = "10-Year Geometric Rolling Average")

#Alternative DR vs. 30-Year TTreasury
#graph <- linePlot(PERSI.data, title = "", inv.returns = FALSE, treasury = TRUE,
#                  font = "Calibri", yaxisMin = 0, yaxisMax = 9, yaxisSeq = 1,
#                  yaxisScale = 100, format = "%", str = 60,
#                  labelY = "", lab1 = "Actual Discount Rate", 
#                  lab2 = "30-Year Treasury Bond Yield Rate", 
#                  lab3 = "Alternative Discount Rate")
#graph
#Example w/ AVA vs. AAL
#PERSI.data <- PERSI.data %>% select(year, ava, aal)
#graph <- linePlot(PERSI.data, title = "", inv.returns = FALSE, treasury = FALSE,
#                  font = "Calibri",
#                  yaxisMin = 0, yaxisMax = 21, yaxisSeq = 3,
#                  yaxisScale = 1/1000000000, format = "$", str = 60,
#                  labelY = "AVA vs. AAL", lab1 = "Actuarial Value of Assets", 
#                  lab2 = "Actuarial Accrued Liabilities")


graph
```

### S&P500 vs. Funded Ratio (2001-2019) w/ R (areaPlot())
```{r sp500, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
rm(list=ls())
###Load/install packages
#R.Version()
#https://github.com/ReasonFoundation/pensionviewr
#Create token -> usethis::edit_r_environ() -> restart -> Sys.getenv("GITHUB_PAT")
#install.packages('devtools')
#library(devtools)
#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
library(ggplot2)
library(tidyverse)
library(tseries)
library(data.table)
library(readr)
library(rsconnect)
library(dplyr)
library(plyr)
library(xlsx)

###
##Pull PERSI data
##Load list of plans
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#write.xlsx(DPF.data, "DPF.data.xlsx")

DPF.data$year <- as.numeric(DPF.data$year)
DPF.data$ava <- as.numeric(DPF.data$ava)
DPF.data$aal <- as.numeric(DPF.data$aal)

## Moving AAL + Payroll 1 year back
DPF.data$aal[1:19] <- DPF.data$aal[2:20]
DPF.data$aal[20] <- NA
DPF.data$funded_ratio[1:19] <- DPF.data$funded_ratio[2:20]
DPF.data$payroll[1:19] <- DPF.data$payroll[2:20]
DPF.data <- DPF.data %>% filter(year < 2020)
#View(DPF.data)

areaPlot <- function(data, title = NULL, caption = FALSE, grid = FALSE, 
  ticks = TRUE, sp500 = FALSE, font) 
{
  if (isTRUE(sp500)) {
    urlfile2 = "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/S%26P500.csv"
    SP500 <- read_csv(url(urlfile2), col_names = TRUE, na = c(""), 
      skip_empty_rows = TRUE, col_types = NULL)
    SP500 <- SP500 %>% filter(year >= 2001 & year < 2020)

    data <- cbind(data, SP500[, 2])
    graph <- data.frame(data %>% select(year, SP500 = sp_500, 
      funded_ratio) %>% tidyr::drop_na())
    #View(graph)
  }
  else {
    data <- as.data.table(data)
    data$uaal <- (data$aal - data$ava)
    
    data <- data %>% dplyr::filter(data$uaal != 0)
    extrapo <- stats::approx(data$year, data$uaal, n = 10000)
    extrapo2 <- stats::approx(data$year, data$funded_ratio, 
      n = 10000)
    graph <- data.frame(year = extrapo$x, uaal = extrapo$y, 
      funded_ratio = extrapo2$y) %>% tidyr::drop_na()
    graph <- graph %>% dplyr::mutate(sign = dplyr::case_when(.data$uaal >= 
      0 ~ "positive", .data$uaal < 0 ~ "negative"))
  }
  graph$funded_ratio <- as.numeric(graph$funded_ratio)
  graph$year <- as.numeric(graph$year)
  if (!isTRUE(sp500)) {
    graph$uaal <- as.numeric(graph$uaal)
  }
  y_minimum <- as.numeric(min(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    0
  }))
  y_maximum <- as.numeric(max(if (!isTRUE(sp500)) {
    graph$uaal
  } else {
    graph$SP500
  }))
  reasontheme::set_reason_theme(style = "slide")

  ggplot2::ggplot(graph, ggplot2::aes(x = graph$year)) + ggplot2::geom_area(ggplot2::aes(y = if (!isTRUE(sp500)) {
    graph$uaal
  }
  else {
    graph$SP500
  }, fill = if (!isTRUE(sp500)) {
    graph$sign
  }
  else {
    palette_reason$Orange
  })) + ggplot2::geom_line(ggplot2::aes(y = graph$funded_ratio * 
    (y_maximum)), color = palette_reason$GreyBlue, size = 1.5) + 
    ggplot2::labs(y = if (!isTRUE(sp500)) {
      "Unfunded Accrued Actuarial Liabilities (Millions)"
    }
    else {
      "S&P500 Index"
    }, x = NULL) + ggplot2::scale_fill_manual(values = if (!isTRUE(sp500)) {
    c(negative = paste(palette_reason$Green), positive = paste(palette_reason$Red))
  }
  else {
    c(paste(palette_reason$Yellow))
  }) + ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
    labels = scales::dollar_format(prefix = if (!isTRUE(sp500)) {
      "$"
    }
    else {
      ""
    }, scale = if (!isTRUE(sp500)) {
      (1e-06)
    }
    else {
      1
    }, largest_with_cents = if (!isTRUE(sp500)) {
      1
    }
    else {
      0.001
    }),  sec.axis = ggplot2::sec_axis(~./(y_maximum/100), 
      breaks = scales::pretty_breaks(n = 10), name = "Funded Ratio", 
      labels = function(b) {
        paste0(round(b, 0), "%")
      }), expand = c(0, 0)) + geom_hline(yintercept = 0, 
    linetype = "solid", color = "black", size = 0.5) + labs(title = paste(title), 
    caption = ifelse(isTRUE(caption), paste("reason.org/pensions"), 
      paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    
    coord_cartesian(expand = FALSE, xlim = c(min(graph$year), 
      max(graph$year)), ylim = c(min(0,y_minimum), y_maximum * 
      1.2)) + ggplot2::scale_x_continuous(breaks = round(seq(min(graph$year), 
    max(graph$year), by = 2), 1), expand = c(0, 0)) + ggplot2::theme(legend.position = "none") + 
    ggplot2::theme(text = element_text(family = paste(font), 
      size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}


sp500 <- areaPlot(DPF.data, caption = F, grid = F, ticks = F, sp500 = T, font = "Calibri")

sp500
```

### Asset Allocation (2001-2019) w/ R (custom)
```{r assets, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
                               plot.margin = margin(1, 1,0,0, "cm"),
                               axis.text.y = element_text(size=9, color = "black"),
                               axis.text.x = element_text(size=9, color = "black", angle = 0, hjust = 0.5, vjust = 0),
                               legend.title = element_text(size = 9, colour = "white", face = "bold"))


#Load Asset Allocation data for PERSI
urlfile2="https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/apps/DPFPS_allocation.csv"
DPF.assets <- data.table(read_csv(url(urlfile2), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = cols(.default = "n")))
DPF.assets <- data.table(DPF.assets[,1:6]) %>% select(year, 
                                            private.equity, alternatives, equity, fixed.income, cash)
#Adding Othe to Alternatives

colnames(DPF.assets) <- c("year", "Private Equity", "Alternatives","Total Equities","Fixed Income",
                          "Cash Equivalents")

#View(PERSI.assets)
#Transpose data from long ot wide format (each year contains Variable & Value)
DPF.assets <- melt(DPF.assets, id.vars="year")

assets <- ggplot(DPF.assets) + geom_area(aes(x = year, y = value, fill = variable, group = variable), position="fill")+
  scale_fill_manual(values=c(palette_reason$Yellow,palette_reason$Orange, 
                             palette_reason$DarkGrey, palette_reason$LightBlue, palette_reason$SatBlue))+
  scale_y_continuous(labels = function(x) paste0(x*100,"%"), name = "% of Investment Portfolio",
                     breaks = seq(0, 1, by = 0.1), limits = c(0, 1), expand=c(0,0))+
  scale_x_continuous(labels = function(x) paste0(x, ""), name = "",
                     breaks = seq(2001, 2019, by = 2), limits = c(2001, 2019), expand=c(0,0))+
  theme_bw()+
  plotTheme+
  theme(legend.position="bottom")

assets
```

### Change in Risk-Free Rate vs. Discount Rate (2001-2019) w/ R (linePlot())
```{r treasury, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#View(DPF.data)

DPF.data$year <- as.numeric(DPF.data$year)
DPF.data$ava <- as.numeric(DPF.data$ava)
DPF.data$aal <- as.numeric(DPF.data$aal)
DPF.data$ava_return <- as.numeric(DPF.data$ava_return)
DPF.data$arr <- as.numeric(DPF.data$arr)
DPF.data$return_1yr <- as.numeric(DPF.data$return_1yr)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

DPF.data <- DPF.data %>% select(year, return_1yr, ava_return, arr, dr)
DPF.data <- data.table(DPF.data)
DPF.data[year == 2005]$ava_return <-   DPF.data[year == 2005]$return_1yr

DPF.data$year <- seq(2000, 2019, by = 1)
DPF.data <- DPF.data %>% filter(year>2000)


linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Green, palette_reason$Yellow, 
    palette_reason$SatBlue, palette_reason$LightGrey, palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 13)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.33, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}


treasury <- linePlot(DPF.data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = TRUE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 9, yaxisSeq = 1,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "Discount Rate or 30-Year Treasury Yield", lab1 = "Actual Discount Rate",
                  lab2 = "30-Year Treasury Bond Yield Rate", 
                  lab3 = "Alternative Discount Rate Scenario", 
                  lab4 = NULL, lab5 = NULL)

treasury
```


### Actual Change in Payroll vs. Assumption (2001-2019) w/ R (linePlot())
```{r payroll, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#View(DPF.data)

DPF.data$payroll <- as.numeric(DPF.data$payroll)
DPF.data$payroll_growth_assumption <- as.numeric(DPF.data$payroll_growth_assumption)
payroll.growth <- DPF.data$payroll_growth_assumption[1]
DPF.data <- DPF.data %>% select(year, payroll, payroll_growth_assumption)
DPF.data <- data.table(DPF.data) %>% filter(year < 2020)

DPF.data$payroll_growth_assumption[1] <- DPF.data$payroll[1]
for(i in (2:length(DPF.data$payroll_growth_assumption))){
  DPF.data$payroll_growth_assumption[i] <- DPF.data$payroll_growth_assumption[i-1]*(1+payroll.growth)
  
}
#View(DPF.data)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

DPF.data <- data.frame(DPF.data)


linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Yellow, palette_reason$SatBlue, 
    palette_reason$SatBlue, palette_reason$LightGrey, palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 13)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.33, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}


payroll <- linePlot(DPF.data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = FALSE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 500, yaxisSeq = 50,
                  yaxisScale = 1/1000000, format = "$", str = 60,
                  labelY = "Payroll in $Millions", lab1 = "Actual Payroll Growth",
                  lab2 = "Projected Payroll Growth Based on 2001 Assumption")

payroll
```


### Actual Inflation vs. Assumption  (2001-2019) w/ R (linePlot())
```{r inflation, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}
pl <- planList()

#PULL DATA

DPF.data <- pullData(pl, "Dallas Police and Fire Pension System")
DPF.data <- filterData(DPF.data, 2001)
#View(DPF.data)

DPF.data$inflation_assum <- as.numeric(DPF.data$inflation_assum)
DPF.data <- DPF.data %>% select(year, inflation_assum, payroll_growth_assumption)
DPF.data <- data.table(DPF.data) %>% filter(year < 2020)

DPF.data$payroll_growth_assumption <- c(
0.023325359,
0.012857978,
0.023081362,
0.025380711,
0.035753575,
0.033988317,
0.029075501,
0.041525047,
-0.004006115,
0.016805793,
0.034447189,
0.021151049,
0.015583985,
0.01689742,
-0.001756654,
0.01105815,
0.020472341,
0.022240635,
0.014533567)
#View(DPF.data)
# UAL4 <- data.table(UAL4[, Tr30 := tr30[(n-UAL4[!is.na(Actual_Return),.N]):last]])
###############
#Adding AVA returns (Arkansas ERS example*)

DPF.data <- data.frame(DPF.data)

linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  })
  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Yellow, palette_reason$SatBlue, 
    palette_reason$SatBlue, palette_reason$LightGrey, palette_reason$LightGreen)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1.5) + ggplot2::geom_hline(yintercept = 0, 
    color = "black") + ggplot2::scale_colour_manual(values = lineColors) + 
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 13)) + 
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = if (isTRUE(treasury)) {
        c(0.1, 1)
      }
      else {
        c(0.33, 0.09)
      }) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}


inflation <- linePlot(DPF.data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = FALSE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = -1, yaxisMax = 6, yaxisSeq = 1,
                  yaxisScale = 100, format = "%", str = 60,
                  labelY = "Inflation %", lab1 = "Assumed Inflation (by DPFPS)",
                  lab2 = "Actual inflation (CPI-U)")

inflation
```

### Debt Interest vs. Unfunded Liability Payments (2001-2019) w/ R (custom)
```{r neg.amo, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

rm(list=ls())

###Load/install packages

#To install `reasontheme` & `pensionviewr` packages you first want to load `devtools`
#install.packages('devtools')
#library(devtools)

#devtools::install_github("ReasonFoundation/reasontheme",force = TRUE)
#devtools::install_github("ReasonFoundation/pensionviewr", force = TRUE)
library(reasontheme)
library(pensionviewr)
#library(janitor)
library(grid)
library(tidyverse)
#library(openxlsx)
library(tseries)
library(plyr)
#library(ggplot2)
library(data.table)
library(openxlsx)
#library(readr)
library(rsconnect)
library(base64enc)
#Shiny
library(shiny)
library(shinyWidgets)
#library(shinyFiles)
library(DT)
library(plotly)
library(rlang)
library(purrr)
library(rpart)
library(vip)

#View(pl <- planList())
#x <- pullStateData(2001)
#view <- masterView("Reason", TRUE)
#View(view)

##1. See what G/L columns consistently have data/most data
#Pull, but not use, "actuarial_experience_dollar" (aggregated)
##2. If Interest_on_Debt is not available? Calculate?
##3. If "amortization_payment_total_amount"is not available? Calculate?
##4. Do Excel G/L matches Database results & UAL change?

####
#Some columns are not filled (especially demographic (e.g. mortality, new entrants, disability, payroll))
#Look into the Code aggregating Survival, Mortality, Survival, Disability data for actives, retired, inactives, total
#Compare Net Change to UAL vs. Actual UAL change for 5-10 plans

#Pull plan-specific data from the database
pl <- planList()
reason.data <- pullData(pl, "Dallas Police and Fire Pension System") %>% filter(year > 2000)# (2002-2020)

#reason.data <- pullData(pl, "Louisiana State Employees Retirement System")# (2002-2019)
#reason.data <- pullData(pl, "New Mexico Public Employees Retirement Association")# (2002-2019)
#reason.data <- pullData(pl, "Teachers’ Retirement System of Louisiana")# (2002-2019)
#reason.data <- pullData(pl, "Arizona Public Safety Personnel Retirement System") (2002-2019)
#reason.data <- pullData(pl, "Georgia Teachers Retirement System")# (2002-2018)

#### Create a list of all Gain/Loss columns we have ####

gain.loss.names <- c("investment_experience_dollar",
                     "age_of_retirement_experience_dollar",
                     "disability_claim_experience_active_dollar",
                     "disability_claim_experience_inactive_dollar",
                     "disability_claim_experience_retired_dollar",
                     "disability_claim_experience_total_dollar",
                     "mortality_rate_experience_active_dollar",
                     "mortality_rate_experience_inactive_dollar",
                     "mortality_rate_experience_retired_dollar",
                     "mortality_rate_experience_total_dollar",
                     "survival_claim_experience_active_dollar",
                     "survival_claim_experience_inactive_dollar",
                     "survival_claim_experience_retired_dollar",
                     "survival_claim_experience_total_dollar",
                     "withdrawal_experience_dollar",
                     "salary_experience_dollar",
                     "payroll_experience_dollar",
                     "new_entrant_experience_dollar",
                     "rehire_experiennce_dollar",
                     "other_actuarial_experience_dollar",
                     "interest_smoothing_dollar",
                     "non_investment_actuarial_experience_dollar",
                     "actuarial_experience_dollar",
                     "legislative_changes_dollar",
                     "changes_to_methods_assumptions_dollar",
                     "interest_on_debt_dollar",
                     "other_interest_dollar",
                     "gain_or_loss_due_to_changes_in_benefits",
                     "gain_or_loss_due_to_changes_in_COLA_provisions",
                     "gain_or_loss_due_to_changes_in_pbi_provisions",
                     "gain_or_loss_due_to_changes_in_normal_cost_prior_year",
                     "gain_or_loss_due_to_changes_in_other_interest",
                     "contribution_deficiency_dollar",
                     #Non-G/L columns that may be empty
                     "amortization_payment_total_amount",
                     "total_amortization_payment_percentage",
                     "covered_payroll_dollar",
                     "fiscal_year_of_contribution",
                     "unfunded_actuarially_accrued_liabilities_dollar")

## How many columns are in the pulled data?
col1 <- ncol(reason.data)
#col1

#### Save names of all the Gain/Loss columns that are currently not in the pulled data
columns2 <- c("test")
for (i in (1:length(gain.loss.names))) {
  if (sum(colnames(reason.data) %in% gain.loss.names[i]) == 0) {
    columns2 <- rbind(columns2, gain.loss.names[i])
  }
}

## Add these columns as empty ones (NA) to the original data
columns2 <- as.character(columns2 <- columns2[2:length(columns2)])
cols <- matrix(NA, length(reason.data[, 1]), length(columns2))
colnames(cols) <- columns2
reason.data <- cbind(reason.data, cols)
reason.data <- data.table(reason.data)

## Number of columns after we added missing G/L columns
col2 <- ncol(reason.data)
#col2
#How many of the total 38 G/L columns were empty & added
#col2-col1

## Filter for G/L columns only
reason.data <- reason.data %>%
  select(year, state, plan_name, gain.loss.names) %>%
  filter(year > 2000)

#View(reason.data)
#View(masterView("Public Plans Database", TRUE))
#x <- masterView("Reason")
#x <- x %>% filter(plan_attribute_id >= 10798)
#10798-10829
#View(x$master_attribute_name[19:63])


## Fill all NAs w/ 0
reason.data <- data.table(reason.data)
reason.data <- reason.data[,lapply(.SD,function(x){ifelse(is.na(x),0,x)})]

## Make sure all column numbers are numeric
reason.data[,4:(length(reason.data)-1)] <- data.table(reason.data[,4:(length(reason.data)-1)]) %>% dplyr::mutate_all(as.numeric)
reason.data$year <- as.numeric(reason.data$year)

#### Add Net Amortization ####
#(Interest on Debt + Amortization Payments)
#Code alternative way>> 
#Amo. contribution % * Future Payroll
future.payroll <- reason.data[year >= fiscal_year_of_contribution[1]]$covered_payroll_dollar
future.payroll <- t(cbind(t(future.payroll),reason.data[year == 2020]$covered_payroll_dollar*(1+0.03)))#Use assumed payroll growth rate
reason.data$payroll2 <- future.payroll

## Calculate net amortization
reason.data <- reason.data[,net_amo := (interest_on_debt_dollar + 
                                      if(sum(reason.data$amortization_payment_total_amount)!=0){
                                        amortization_payment_total_amount}else{
                                        total_amortization_payment_percentage * payroll2})]


#View(reason.data)
net.amo <- reason.data %>% select(year, state, plan_name, interest_on_debt_dollar, unfunded_actuarially_accrued_liabilities_dollar, net_amo)

net.amo$year <- as.numeric(net.amo$year) 
net.amo$unfunded_actuarially_accrued_liabilities_dollar <- as.numeric(net.amo$unfunded_actuarially_accrued_liabilities_dollar) 
net.amo$net_amo <- as.numeric(net.amo$net_amo) 
lineColors <- c(palette_reason$SpaceGrey, palette_reason$SpaceGrey)
#View(net.amo)

net.amo$over <- 0
net.amo$over[1:2] <- -net.amo$net_amo[1:2]
net.amo$net_amo[1:2] <- 0
net.amo$net_amo <- -net.amo$net_amo
net.amo$over[3:20] <- 0
net.amo$ual <- net.amo$unfunded_actuarially_accrued_liabilities_dollar + net.amo$net_amo
net.amo <- data.frame(net.amo)


plotTheme <- ggplot2::theme(   panel.grid.major = element_blank(),
                               panel.grid.minor = element_blank(), 
                               axis.line = element_line(colour = "black"),
                               plot.margin = margin(1, 1,0,0, "cm"),
                               axis.text.y = element_text(size=9, color = "black"),
                               axis.text.x = element_text(size=9, color = "black", angle = 0, hjust = 0.5, vjust = 0),
                               legend.title = element_text(size = 9, colour = "white", face = "bold"))

 

#reasontheme::set_reason_theme(style = "slide")
# added inside the scale_y_continuous the limits=c(ymin, ymax) to control the y limits
net.amo <- ggplot() + 
  # this is used to build the bars alpha is opacity of the bars
    
  geom_col(data=net.amo, mapping=aes(x = year, y = ual), 
           fill = palette_reason$SpaceGrey, color = palette_reason$SpaceGrey)+
  #geom_col(data=net.amo, mapping=aes(x = year, y = over),
  #         fill = palette_reason$Green, color = palette_reason$Green)+
  geom_col(data=net.amo, mapping=aes(x = year, y = net_amo),
           fill = palette_reason$Red, color = palette_reason$Red)+

  
  
 theme(panel.grid.major.y = element_line(colour = "white", size = 3))+
   scale_y_continuous(breaks = pretty_breaks(n = 10),
                      labels = function(x) paste0("$", x/1000000000), 
                      name = "Unfunded Liability Payments (in $Billions)",
                      limits = c(-500000000, 3500000000),
                      expand=c(0,0))+
  scale_x_continuous(labels = function(x) paste0(x, ""), name = "",
                     breaks = seq(2001, 2019, by = 2), limits = c(2001, 2019), expand=c(0,0))+
  
  # be careful because wit the names of the columns in the data_perc, they must match
  ##geom_line(data = data_perc, aes(X1, X2), size=2, color="orange")+
  theme_bw()+
  plotTheme

net.amo
#ggsave(filesave)
```

### Current Contributions Are Actuarially Insufficient (2001-2019) w/ R (linePlot())
```{r crises, dpi=400, fig.width=8, fig.height=5, fig.align = "center", message=FALSE, warning=FALSE}

urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/GraphicsR/master/DeckUpdate/crises.csv"
stress <- data.frame(
  read_csv(url(urlfile), col_names = TRUE, na = c(""), skip_empty_rows = TRUE, col_types = NULL)
)
#View(stress)

DPF.data <- data.table(stress)
colnames(DPF.data) <- c("year",
                        "baseline", 
                        "crisis", "2crises", 
                        "crisis_freeze","2crises_freeze",
                        "6_constant")
#View(DPF.data)

DPF.data <- DPF.data %>% select("year",
                        "baseline", "6_constant",
                        "crisis", "crisis_freeze",
                        "2crises", "2crises_freeze")

linePlot <- function (data, title = NULL, caption = FALSE, grid = FALSE, 
  treasury = FALSE, inv.returns = TRUE, ticks = TRUE, font = NULL, 
  yaxisMin = 0, yaxisMax = NULL, yaxisSeq = 5, yaxisScale = 100, 
  format = NULL, str = 20, labelY = NULL, lab1 = NULL, lab2 = NULL, 
  lab3 = NULL, lab4 = NULL, lab5 = NULL, lab6 = NULL) 
{
  reasontheme::set_reason_theme(style = "slide")
  x <- length(data$year)
  data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
  if (isTRUE(treasury)) {
    urlfile <- "https://raw.githubusercontent.com/ReasonFoundation/databaseR/master/files/treasury.csv"
    treasury <- read_csv(url(urlfile), col_names = TRUE, 
      na = c(""), skip_empty_rows = TRUE, col_types = NULL)
    treasury$year <- as.numeric(treasury$year)
    treasury <- treasury %>% filter(year>2000 & year < 2020)
    data$year <- as.numeric(data$year)
    treasury <- data.table(treasury %>% filter(year > min(data$year - 
      1)))
    data <- data %>% select(year, arr)
    data <- data.table(data)
    data <- cbind(data, treasury[, 2])
    data <- data.frame(data) %>% dplyr::mutate_all(as.numeric)
    data <- as.data.table(data)
    data$alt.discount <- NA
    diff <- (data[year == min(data$year)]$arr - data[year == 
      min(data$year)]$X30.treasury)
    data$alt.discount <- data$X30.treasury + diff
  }
  geomean <- function(x) {
    x <- as.vector(na.omit(x))
    x <- x + 1
    exp(mean(log(x))) - 1
  }
  if (isTRUE(inv.returns)) {
    data$return_1yr <- as.numeric(data$return_1yr)
    returns <- data$return_1yr
    last <- length(returns)
    rolling <- matrix(NA, last, 1)
    rolling[last] <- as.numeric(geomean(returns[(last - 
      9):last]))
    for (i in 1:(last - 10)) {
      rolling[last - i] <- geomean(returns[(last - 9 - 
        i):(last - i)])
    }
    rolling <- data.table(rolling)
    returns[(last - 9):last]
    returns[(last - 9 + 1):(last - 1)]
    data <- data.table(cbind(data, rolling))
    data <- data %>% select(year, return_1yr, ava_return, 
      arr, V1)
  }
  colnames(data) <- c("year", if (!is_null(lab1)) {
    paste(lab1)
  }, if (!is_null(lab2)) {
    paste(lab2)
  }, if (!is_null(lab3)) {
    paste(lab3)
  }, if (!is_null(lab4)) {
    paste(lab4)
  }, if (!is_null(lab5)) {
    paste(lab5)
  }, if (!is_null(lab6)) {
    paste(lab6)
  })
  ##Crate line types per variable

  graph <- data.table(melt(data, id.vars = "year"))
  lineColors <- c(palette_reason$Orange, palette_reason$LightOrange, 
  palette_reason$SatBlue, palette_reason$LightBlue, palette_reason$Yellow, palette_reason$Yellow)
  options(repr.plot.width = 1, repr.plot.height = 0.75)
  ggplot2::ggplot(graph, ggplot2::aes(x = year, y = yaxisScale * 
    value, group = variable, linetype=variable)) + ggplot2::geom_line(ggplot2::aes(colour = str_wrap(factor(variable), 
    str)), size = 1) + 
    ggplot2::geom_hline(yintercept = 0, color = "black") + 
    ggplot2::scale_colour_manual(values = lineColors) + 
    scale_linetype_manual(values=c("solid", "dashed",  "solid", "dashed","solid","dashed"))+#Assigns line types set to each line
    ggplot2::scale_y_continuous(breaks = seq(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    }
    else {
      max(graph$value) * yaxisScale * 1.2
    }, by = yaxisSeq), limits = c(yaxisMin, if (!is.null(yaxisMax)) {
      yaxisMax
    } else {
      max(graph$value) * yaxisScale * 1.2
    }), labels = function(b) {
      if (format == "%") {
        paste0(round(b, 0), "%")
      }
      else if (format == "$") {
        paste0("$", round(b, 0))
      }
      else {
        paste0(format, round(b, 0))
      }
    }, expand = c(0, 0)) + ggplot2::scale_x_continuous(breaks = seq(min(graph$year), 
    max(graph$year), by = 2), expand = c(0, 0)) + labs(x = element_blank(), 
    y = labelY) + theme(legend.text = element_text(size = 12)) + 
    
    theme(legend.direction = "vertical", legend.box = "horizontal", 
      legend.position = 
        c(0.8, 0.14)) + labs(title = paste(title), caption = ifelse(isTRUE(caption), 
    paste("reason.org/pensions"), paste(""))) + ggplot2::theme(axis.ticks = if (isFALSE(ticks)) {
    ggplot2::element_blank()
  }
  else {
    ggplot2::element_line()
  }) + ggplot2::theme(axis.ticks.x = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.ticks.y = element_line(size = 0.5, 
    color = "black")) + ggplot2::theme(axis.text = element_text(size = 12), 
    axis.title = element_text(size = 12, face = "bold")) + 
    ggplot2::theme(text = element_text(family = if (!is_null(font)) {
      paste(font)
    }
    else {
      paste("Arial")
    }, size = 9)) + ggplot2::theme(panel.grid.major.y = element_line(colour = ifelse(isTRUE(grid), 
    paste(palette_reason$SpaceGrey), "white"), size = (1)))
}

crises <- linePlot(DPF.data, title = NULL, caption = FALSE, grid = FALSE, 
                  treasury = FALSE, inv.returns = FALSE, ticks = TRUE, font = "Calibri",
                  yaxisMin = 0, yaxisMax = 30, yaxisSeq = 3,
                  yaxisScale = 100, format = "%", str = 80,
                  labelY = "Employer Contribution (% Payroll)", 
                  lab1 = "Baseline",
                  lab2 = "6% Constant Annual Return",
                  lab3 = "2021-24 Crisis & 6% Returns",
                  lab4 = "2021-24 Crisis & 6% Returns & 5-Year Contribution Freeze", 
                  lab5 = "2021-24 Crisis & 2036-39 Crisis & 6% Returns", 
                  lab6 = "2021-24 Crisis & 2036-39 Crisis & 6% Returns & 5-Year Contribution Freeze")
                 

crises
```